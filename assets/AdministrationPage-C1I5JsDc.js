import{j as e}from"./charts-nuwTBMFx.js";import{r as a}from"./react-DGBwUpAK.js";import{l as pe,m as xe,n as V,o as he,p as fe,q as be}from"./api-DYJm7ZOt.js";import{a as f,D as W,b as ge,c as je,d as Ne,f as X}from"./App-BenPhVbi.js";import{D as ee}from"./DeleteConfirmModal-IVzid9wc.js";import"./index-DJao75Ul.js";function te(){const l=new Date;return l.setUTCFullYear(l.getUTCFullYear()+1),l.toISOString().slice(0,10)}function ye(l){return new Date(`${l}T23:59:59.999Z`).toISOString()}function ve(l){const n=Date.parse(l),d=Number.isNaN(n)||n<Date.now()?new Date:new Date(n);return d.setUTCFullYear(d.getUTCFullYear()+1),d.setUTCHours(23,59,59,999),d.toISOString()}function we(l){const n=new Date(l);return Number.isNaN(n.getTime())?"Date invalide":new Intl.DateTimeFormat("fr-FR",{dateStyle:"medium"}).format(n)}function Te(l,n){return l.phase!==n.phase?l.phase.localeCompare(n.phase,"fr"):l.name.localeCompare(n.name,"fr")}function Ue(){const[l,n]=a.useState([]),[d,w]=a.useState(!0),[T,i]=a.useState(null),[S,c]=a.useState(null),[u,b]=a.useState(null),[g,C]=a.useState(""),[k,D]=a.useState(""),[j,E]=a.useState(""),[A,U]=a.useState("team"),[N,L]=a.useState(te()),[I,F]=a.useState(!1),P=f(),[p,M]=a.useState(()=>P??[]),[se,h]=a.useState(!P),[R,o]=a.useState(null),[q,O]=a.useState(null),[x,y]=a.useState(null),[v,Y]=a.useState(""),[B,G]=a.useState(""),[_,$]=a.useState("Préparation"),[z,H]=a.useState("Google Doc"),[Z,J]=a.useState(!1),K=a.useMemo(()=>[...l].sort((t,s)=>t.email.localeCompare(s.email,"fr")),[l]),Q=a.useMemo(()=>[...p].sort(Te),[p]),ae=a.useMemo(()=>W.map(t=>({phase:t,templates:Q.filter(s=>s.phase===t)})),[Q]),re=async()=>{w(!0),i(null);try{const t=await pe();n(t)}catch(t){i(t instanceof Error?t.message:"Impossible de charger les utilisateurs")}finally{w(!1)}};a.useEffect(()=>{re().catch(t=>{console.error("Failed to load users:",t)})},[]),a.useEffect(()=>{let t=!0;const s=f();s?(M(s),h(!1)):h(!0);const r=ge(m=>{t&&(M(m??[]),h(!1))});return s||je().catch(m=>{t&&(o(m instanceof Error?m.message:"Impossible de charger les modèles"),h(!1))}),()=>{t=!1,r()}},[]);const le=async t=>{if(t.preventDefault(),i(null),!g.trim()){i("Le nom est requis.");return}const s=k.trim().toLowerCase();if(!s.includes("@")){i("L'email semble invalide.");return}if(j.trim().length<8){i("Le mot de passe doit contenir au moins 8 caractères.");return}if(!N){i("La date d'expiration est requise.");return}F(!0);try{const r=await xe({name:g.trim(),email:s,password:j,role:A,status:"active",expiresAt:ye(N)});n(m=>[r,...m]),C(""),D(""),E(""),U("team"),L(te())}catch(r){i(r instanceof Error?r.message:"Impossible de créer le compte")}finally{F(!1)}},ne=async t=>{c(t.id),i(null);try{const s=await V(t.id,{status:t.status==="active"?"suspended":"active"});n(r=>r.map(m=>m.id===s.id?s:m))}catch(s){i(s instanceof Error?s.message:"Impossible de changer le statut")}finally{c(null)}},ie=async t=>{c(t.id),i(null);try{const s=await V(t.id,{expiresAt:ve(t.expiresAt)});n(r=>r.map(m=>m.id===s.id?s:m))}catch(s){i(s instanceof Error?s.message:"Impossible de prolonger le compte")}finally{c(null)}},me=async t=>{c(t.id),i(null);try{await fe(t.id),n(s=>s.filter(r=>r.id!==t.id))}catch(s){i(s instanceof Error?s.message:"Impossible de supprimer le compte")}finally{c(null)}},oe=async t=>{if(t.preventDefault(),o(null),!v.trim()){o("Le nom du document est requis.");return}let s;try{s=new URL(B.trim()).toString()}catch{o("Le lien doit être une URL valide (ex: https://drive.google.com/...).");return}J(!0);try{const m=[await he({name:v.trim(),url:s,phase:_,type:z}),...f()??p];X(m),Y(""),G(""),$("Préparation"),H("Google Doc")}catch(r){o(r instanceof Error?r.message:"Impossible de créer le modèle")}finally{J(!1)}},de=async t=>{O(t.id),o(null);try{await be(t.id);const s=f()??p;X(s.filter(r=>r.id!==t.id))}catch(s){o(s instanceof Error?s.message:"Impossible de supprimer le modèle")}finally{O(null)}},ce=async()=>{if(!u)return;await me(u),b(null)},ue=async()=>{if(!x)return;await de(x),y(null)};return e.jsxs("div",{className:"mx-auto w-full max-w-5xl space-y-10",children:[e.jsxs("header",{className:"border-b border-stone pb-10",children:[e.jsx("p",{className:"mb-4 text-xs font-bold uppercase tracking-widest text-flame",children:"Administration"}),e.jsx("h1",{className:"mb-5 font-serif text-5xl text-ink md:text-6xl",children:"Gestion des accès"}),e.jsx("p",{className:"max-w-3xl text-lg font-light text-graphite md:text-xl",children:"Gestion des utilisateurs Team et des modèles de documents."})]}),e.jsxs("section",{className:"rounded-brand border border-stone bg-white p-6",children:[e.jsx("h2",{className:"mb-4 font-serif text-2xl text-ink",children:"Ajouter un compte"}),e.jsxs("form",{onSubmit:le,className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-name",className:"mb-1 block text-sm font-medium text-ink",children:"Nom"}),e.jsx("input",{id:"admin-name",type:"text",value:g,onChange:t=>C(t.target.value),className:"field-input",placeholder:"Prénom Nom",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-email",className:"mb-1 block text-sm font-medium text-ink",children:"Email"}),e.jsx("input",{id:"admin-email",type:"email",value:k,onChange:t=>D(t.target.value),className:"field-input",placeholder:"nom@weloveusers.com",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-password",className:"mb-1 block text-sm font-medium text-ink",children:"Mot de passe"}),e.jsx("input",{id:"admin-password",type:"password",value:j,onChange:t=>E(t.target.value),className:"field-input",placeholder:"Minimum 8 caractères",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"mb-1 block text-sm font-medium text-ink",children:"Rôle"}),e.jsxs("select",{id:"admin-role",value:A,onChange:t=>{const s=t.target.value==="admin"?"admin":"team";U(s)},className:"field-select",children:[e.jsx("option",{value:"team",children:"team"}),e.jsx("option",{value:"admin",children:"admin"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-expiry",className:"mb-1 block text-sm font-medium text-ink",children:"Expiration"}),e.jsx("input",{id:"admin-expiry",type:"date",value:N,onChange:t=>L(t.target.value),className:"field-input",required:!0})]}),e.jsx("div",{className:"md:col-span-3",children:e.jsx("button",{type:"submit",disabled:I,className:"btn-primary-sm disabled:cursor-not-allowed disabled:opacity-70",children:I?"Création...":"Ajouter le compte"})}),T&&e.jsx("div",{className:"md:col-span-3 rounded-lg bg-danger-50 px-3 py-2 text-sm text-berry",children:T})]})]}),e.jsxs("section",{className:"rounded-brand border border-stone bg-white p-6",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsx("h2",{className:"font-serif text-2xl text-ink",children:"Comptes enregistrés"}),e.jsxs("span",{className:"text-xs font-medium uppercase tracking-wide text-taupe",children:[l.length," compte(s)"]})]}),d?e.jsx("p",{className:"text-sm text-graphite",children:"Chargement..."}):K.length===0?e.jsx("p",{className:"text-sm text-graphite",children:"Aucun compte ajouté pour le moment."}):e.jsx("ul",{className:"space-y-2",children:K.map(t=>{const s=S===t.id,r=Date.parse(t.expiresAt)<=Date.now();return e.jsxs("li",{className:"flex flex-wrap items-center justify-between gap-3 rounded-lg border border-stone px-3 py-2",children:[e.jsxs("div",{className:"min-w-[220px]",children:[e.jsx("p",{className:"text-sm font-medium text-ink",children:t.name}),e.jsx("p",{className:"text-xs text-graphite",children:t.email})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs uppercase text-taupe",children:t.role}),e.jsx("span",{className:`badge-severity ${t.status==="active"?"badge-severity-sage":"badge-severity-flame"}`,children:t.status==="active"?"Actif":"Suspendu"}),r&&e.jsx("span",{className:"badge-severity badge-severity-flame",children:"Expiré"})]}),e.jsxs("div",{className:"min-w-[180px] text-xs text-graphite",children:["Expire le ",we(t.expiresAt)]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>ie(t),disabled:s,className:"text-xs text-flame hover:underline disabled:opacity-70",children:"Prolonger +1 an"}),e.jsx("button",{type:"button",onClick:()=>ne(t),disabled:s,className:"text-xs text-flame hover:underline disabled:opacity-70",children:t.status==="active"?"Suspendre":"Réactiver"}),e.jsx("button",{type:"button",onClick:()=>b(t),disabled:s,className:"text-xs text-graphite hover:text-berry disabled:opacity-70",children:"Supprimer"})]})]},t.id)})})]}),e.jsxs("section",{className:"rounded-brand border border-stone bg-white p-6",children:[e.jsx("h2",{className:"mb-4 font-serif text-2xl text-ink",children:"Ajouter un modèle de document"}),e.jsxs("form",{onSubmit:oe,className:"grid gap-4 md:grid-cols-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"tpl-name",className:"mb-1 block text-sm font-medium text-ink",children:"Nom"}),e.jsx("input",{id:"tpl-name",type:"text",value:v,onChange:t=>Y(t.target.value),className:"field-input",placeholder:"Ex : Guide d'entretien découverte",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tpl-phase",className:"mb-1 block text-sm font-medium text-ink",children:"Phase"}),e.jsx("select",{id:"tpl-phase",value:_,onChange:t=>$(t.target.value),className:"field-select",children:W.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tpl-type",className:"mb-1 block text-sm font-medium text-ink",children:"Type"}),e.jsx("select",{id:"tpl-type",value:z,onChange:t=>H(t.target.value),className:"field-select",children:Ne.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"md:col-span-4",children:[e.jsx("label",{htmlFor:"tpl-url",className:"mb-1 block text-sm font-medium text-ink",children:"URL"}),e.jsx("input",{id:"tpl-url",type:"url",value:B,onChange:t=>G(t.target.value),className:"field-input",placeholder:"https://...",required:!0})]}),e.jsx("div",{className:"md:col-span-4",children:e.jsx("button",{type:"submit",disabled:Z,className:"btn-primary-sm disabled:cursor-not-allowed disabled:opacity-70",children:Z?"Ajout...":"Ajouter le modèle"})}),R&&e.jsx("div",{className:"md:col-span-4 rounded-lg bg-danger-50 px-3 py-2 text-sm text-berry",children:R})]})]}),e.jsxs("section",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"font-serif text-2xl text-ink",children:"Modèles enregistrés"}),e.jsxs("span",{className:"text-xs font-medium uppercase tracking-wide text-taupe",children:[p.length," modèle(s)"]})]}),se?e.jsx("p",{className:"rounded-brand border border-stone bg-white p-4 text-sm text-graphite",children:"Chargement..."}):ae.map(t=>e.jsxs("article",{className:"rounded-brand border border-stone bg-white p-6",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between gap-3",children:[e.jsx("h3",{className:"font-serif text-2xl text-ink",children:t.phase}),e.jsxs("span",{className:"text-xs font-medium uppercase tracking-wide text-taupe",children:[t.templates.length," modèle(s)"]})]}),t.templates.length===0?e.jsx("p",{className:"text-sm text-graphite",children:"Aucun modèle pour cette phase."}):e.jsx("ul",{className:"space-y-2",children:t.templates.map(s=>{const r=q===s.id;return e.jsxs("li",{className:"flex flex-wrap items-center justify-between gap-3 rounded-lg border border-stone px-3 py-2",children:[e.jsxs("div",{className:"min-w-[220px]",children:[e.jsx("a",{href:s.url,target:"_blank",rel:"noreferrer",className:"text-sm font-medium text-flame hover:underline",children:s.name}),e.jsx("p",{className:"text-xs uppercase tracking-wide text-taupe",children:s.type})]}),e.jsx("button",{type:"button",onClick:()=>y(s),disabled:r,className:"text-xs text-graphite hover:text-berry disabled:opacity-70",children:"Supprimer"})]},s.id)})})]},t.phase))]}),u&&e.jsx(ee,{title:"Supprimer le compte",message:`Le compte « ${u.email} » sera supprimé définitivement.`,onConfirm:ce,onCancel:()=>b(null),loading:S===u.id}),x&&e.jsx(ee,{title:"Supprimer le modèle",message:`Le modèle « ${x.name} » sera supprimé.`,onConfirm:ue,onCancel:()=>y(null),loading:q===x.id})]})}export{Ue as AdministrationPage};
